!function(window,angular){function Utils($location,$log){function isMobileValid(mobile){return/^1\d{10}$/.test(mobile)}function isBlank(str){return!str||/^\s*$/.test(str)}function isNumber(n){return!isNaN(n)}function toPercent(value){return Math.min(Math.round(1e4*value)/100,100)}return{isBlank:isBlank,isMobileValid:isMobileValid,isNumber:isNumber,toPercent:toPercent}}angular.module("module.services",[]).service("Utils",Utils)}(window,window.angular),function(window,angular){function configCompileProvider($compileProvider){$compileProvider.imgSrcSanitizationWhitelist(/^\s*(https|file|blob|cdvfile|http|chrome-extension|blob:chrome-extension):|data:image\//)}function configHttpProvider($httpProvider){$httpProvider.defaults.headers.common["Content-Type"]="application/json",$httpProvider.defaults.headers.post["Content-Type"]="application/json"}function extendLog($provide){$provide.decorator("$log",function($delegate,$injector){var _log=$delegate.log;return $delegate.log=function(msg,forceLog){return _log(msg),this},$delegate})}function initApp($rootScope,$http){$rootScope.loadingPage=!0,$rootScope.clickPage=function(){$rootScope.$broadcast("page_clicked",{})}}angular.module("how2read",["module.services"]).config(configCompileProvider).config(configHttpProvider).config(extendLog).run(initApp)}(window,window.angular),function(window,angular){function IssueCtrl($rootScope,$http,$log){function activate(){vm.currentPage="kickoff",vm.issueId=1,vm.userId=1,vm.questionIndex=-1,vm.questions=[],vm.summary={user_count:0,correct_rate:0},$http.get("/api/issues/"+vm.issueId+"/questions").then(function(response){vm.questions=response.data,$log.log(vm.questions)},function(response){}),$http.get("/api/issues/1/summary").then(function(response){vm.summary=response.data,$log.log(vm.questions)},function(response){})}function showQuestionPage(){vm.currentPage="question",vm.nextQuestion()}function nextQuestion(){return vm.questions.length>0&&vm.questionIndex>=vm.questions.length-1?void vm.showResultPage():(vm.questionIndex++,void(vm.question=vm.questions[vm.questionIndex]))}function nextQuestionText(){return vm.questions.length&&vm.questionIndex>=vm.questions.length-1?"查看成绩":"下一题"}function getChoiceName(choice){return[choice.name,choice.name1].join(", ")}function vote(question,choice){question.is_voted||vm.voting||(vm.voting=!0,$http.post("/api/questions/"+question.id+"/vote/"+choice.id).then(function(response){vm.voting=!1,question.is_voted=!0,question.is_correct=choice.id==response.data.correct_id,choice.is_voted=!0,question.choices.forEach(function(choice){choice.is_correct=choice.id==response.data.correct_id}),vm.questionIndex>=vm.questions.length-1&&vm.onVoteFinished()},function(response){vm.voting=!1}))}function onVoteFinished(){var rate=vm.questions.length>0?vm.getCorrectCount()/vm.questions.length*100:100;$http.get("/api/issues/"+vm.issueId+"/over_takes/"+rate).then(function(response){vm.summary.over_takes_rate=vm.getOverTakesRate(response.over_takes)},function(response){})}function getOverTakesRate(over_takes){return 0==over_takes?0:0==vm.summary.user_count?100:over_takes>=vm.summary.user_count?100:over_takes/vm.summary.user_count*100}function getCorrectCount(){return vm.questions.filter(function(q){return q.is_correct}).length}function showResultPage(){vm.currentPage="result"}function clickPage(){}var vm=this;vm.nextQuestion=nextQuestion,vm.nextQuestionText=nextQuestionText,vm.getChoiceName=getChoiceName,vm.vote=vote,vm.onVoteFinished=onVoteFinished,vm.showQuestionPage=showQuestionPage,vm.showResultPage=showResultPage,vm.clickPage=clickPage,vm.getCorrectCount=getCorrectCount,vm.getOverTakesRate=getOverTakesRate,activate()}angular.module("how2read").controller("IssueCtrl",IssueCtrl)}(window,window.angular),function(window,angular){function QuestionAddCtrl($rootScope,$http,$log,Utils){function activate(){vm.duplicateQuestions=[],vm.nameIsEmpty=!0,vm.nameDuplicate=!1,vm.initQuestionPage()}function initQuestionPage(){vm.question={name:"",description:"",correctChoiceChecked:!0,correctChoice:{name:"",name1:""},choices:[{t:Date.now(),name:"",name1:""}]},vm.currentPage="add"}function addChoice(){vm.question.choices.push({t:Date.now(),name:"",name1:""})}function removeChoice(choice){vm.question.choices=vm.question.choices.filter(function(c){return c.t!=choice.t})}function quickValidateName(){return vm.nameIsEmpty=Utils.isBlank(vm.question.name),vm.nameIsEmpty||(vm.nameDuplicate=vm.duplicateQuestions.some(function(question){return question.name.toLowerCase()==vm.question.name.toLowerCase()})),vm.nameIsEmpty||vm.nameDuplicate}function fullValidateName(){vm.quickValidateName()||$http.get("/api/questions/find_by_name/"+vm.question.name).then(function(response){Utils.isBlank(response.data)?vm.nameDuplicate=!1:(vm.duplicateQuestions.push(response.data),vm.nameDuplicate=!0)},function(response){})}function validateChoiceName(choice){return choice.nameHasError=Utils.isBlank(choice.name),choice.nameHasError}function validateAll(){return vm.quickValidateName(),vm.question.correctChoiceChecked&&vm.validateChoiceName(vm.question.correctChoice),vm.question.choices.forEach(function(c){vm.validateChoiceName(c)}),vm.canSubmit()}function getNameDuplicateDesc(){var question=vm.duplicateQuestions.find(function(question){return question.name.toLowerCase()==vm.question.name.toLowerCase()});return Utils.isBlank(question)?"":question.issue_id<=0?question.name+"，已经存在，尚未发布":question.name+"，收录于第"+question.issue_id+"期"}function canSubmit(){return vm.nameIsEmpty||vm.nameDuplicate?!1:vm.question.correctChoiceChecked&&vm.question.correctChoice.nameHasError?!1:!vm.question.choices.some(function(c){return c.nameHasError})}function submit(){vm.processing||vm.validateAll()&&(vm.processing=!0,$http.post("/api/questions",vm.question).then(function(response){vm.processing=!1,vm.currentPage="result"},function(response){vm.processing=!1}))}var vm=this;vm.initQuestionPage=initQuestionPage,vm.validateAll=validateAll,vm.quickValidateName=quickValidateName,vm.fullValidateName=fullValidateName,vm.validateChoiceName=validateChoiceName,vm.getNameDuplicateDesc=getNameDuplicateDesc,vm.addChoice=addChoice,vm.removeChoice=removeChoice,vm.canSubmit=canSubmit,vm.submit=submit,activate()}angular.module("how2read").controller("QuestionAddCtrl",QuestionAddCtrl)}(window,window.angular);